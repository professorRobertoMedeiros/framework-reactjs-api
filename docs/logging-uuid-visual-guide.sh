#!/bin/bash

# Script de demonstraÃ§Ã£o visual do sistema de logging com UUID

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                                                                            â•‘"
echo "â•‘          ğŸ¯ SISTEMA DE LOGGING COM UUID ÃšNICO POR REQUISIÃ‡ÃƒO             â•‘"
echo "â•‘                                                                            â•‘"
echo "â•‘  Cada requisiÃ§Ã£o HTTP possui um UUID Ãºnico que Ã© propagado                â•‘"
echo "â•‘  automaticamente para TODOS os logs, incluindo queries SQL!               â•‘"
echo "â•‘                                                                            â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo ""
echo "ğŸ“‹ ARQUITETURA DO SISTEMA"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "  â”‚  HTTP Request   â”‚  â† Cliente faz requisiÃ§Ã£o"
echo "  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo "           â”‚"
echo "           â–¼"
echo "  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "  â”‚ TracingMiddleware   â”‚  â† Gera UUID: 550e8400-e29b-41d4..."
echo "  â”‚ (addRequestId)      â”‚     Armazena em AsyncLocalStorage"
echo "  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo "           â”‚"
echo "           â–¼"
echo "  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "  â”‚ HTTPLoggerMiddlewareâ”‚  â† Log: [RequestID: 550e8400...]"
echo "  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo "           â”‚"
echo "           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "           â”‚                          â”‚"
echo "           â–¼                          â–¼"
echo "  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "  â”‚ Route Handler   â”‚      â”‚ Business Logic   â”‚"
echo "  â”‚ (products.ts)   â”‚      â”‚ (ProductBusiness)â”‚"
echo "  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo "           â”‚                        â”‚"
echo "           â”‚  Logs com UUID         â”‚  Logs com UUID"
echo "           â”‚                        â”‚"
echo "           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo "                    â”‚"
echo "                    â–¼"
echo "           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "           â”‚ Repository       â”‚  â† Logs com UUID"
echo "           â”‚ (ProductRepo)    â”‚"
echo "           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo "                    â”‚"
echo "                    â–¼"
echo "           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "           â”‚ CustomORM        â”‚  â† Logs SQL com UUID"
echo "           â”‚ (queries)        â”‚"
echo "           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo "                    â”‚"
echo "                    â–¼"
echo "           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "           â”‚ PostgreSQL â”‚  â† Query executada"
echo "           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo ""
echo ""
echo "âœ… RESULTADO: Todos os logs possuem o MESMO UUID!"
echo ""
echo ""
echo "ğŸ“Š EXEMPLO DE LOGS GERADOS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "  ğŸŸ¢ [INFO] [HTTP] [RequestID: 550e8400-e29b-41d4] Received POST /api/products"
echo "     â””â”€ RequisiÃ§Ã£o recebida"
echo ""
echo "  ğŸŸ¢ [INFO] [APP] [RequestID: 550e8400-e29b-41d4] Creating new product"
echo "     â””â”€ Route handler"
echo ""
echo "  ğŸŸ¢ [INFO] [APP] [RequestID: 550e8400-e29b-41d4] Business: Starting creation"
echo "     â””â”€ Business logic"
echo ""
echo "  ğŸ”µ [DEBUG] [APP] [RequestID: 550e8400-e29b-41d4] Repository: Inserting product"
echo "     â””â”€ Repository"
echo ""
echo "  ğŸ”µ [DEBUG] [SQL] [RequestID: 550e8400-e29b-41d4] SQL INSERT executed"
echo "     SQL: { query: 'INSERT INTO products ...', params: [...], duration: 5ms }"
echo "     â””â”€ Query SQL executada"
echo ""
echo "  ğŸŸ¢ [INFO] [APP] [RequestID: 550e8400-e29b-41d4] Product created successfully"
echo "     â””â”€ Sucesso na criaÃ§Ã£o"
echo ""
echo "  ğŸŸ¢ [INFO] [HTTP] [RequestID: 550e8400-e29b-41d4] POST /api/products 201 - 45ms"
echo "     â””â”€ Resposta enviada"
echo ""
echo ""
echo "ğŸ” RASTREAMENTO"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "  # Ver TODOS os logs de uma requisiÃ§Ã£o especÃ­fica:"
echo "  grep '550e8400-e29b-41d4' logs/*.log"
echo ""
echo "  # Filtrar em JSON:"
echo "  cat logs/http-*.log | jq 'select(.requestId == \"550e8400-e29b-41d4\")'"
echo ""
echo "  # Ver apenas queries SQL de uma requisiÃ§Ã£o:"
echo "  cat logs/sql-*.log | jq 'select(.requestId == \"550e8400-e29b-41d4\")'"
echo ""
echo "  # RequisiÃ§Ãµes lentas (> 1 segundo):"
echo "  cat logs/http-*.log | jq 'select(.data.duration > 1000)'"
echo ""
echo "  # Queries SQL lentas (> 100ms):"
echo "  cat logs/sql-*.log | jq 'select(.sql.duration > 100)'"
echo ""
echo ""
echo "âš™ï¸  CONFIGURAÃ‡ÃƒO"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "  1. .env:"
echo "     LOG_ENABLED=true"
echo "     LOG_LEVEL=debug"
echo "     LOG_SQL=true"
echo "     LOG_HTTP=true"
echo ""
echo "  2. Express setup (apenas 2 linhas!):"
echo "     app.use(TracingMiddleware.addRequestId());"
echo "     app.use(HTTPLoggerMiddleware.log());"
echo ""
echo "  3. Pronto! ğŸ‰"
echo ""
echo ""
echo "ğŸ¯ BENEFÃCIOS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "  âœ… Rastreamento completo de requisiÃ§Ãµes"
echo "  âœ… Logs SQL incluem UUID automaticamente"
echo "  âœ… Debug muito mais rÃ¡pido em produÃ§Ã£o"
echo "  âœ… Zero configuraÃ§Ã£o manual (AsyncLocalStorage)"
echo "  âœ… CompatÃ­vel com ELK Stack, Grafana Loki, etc"
echo "  âœ… NÃ£o quebra cÃ³digo existente"
echo ""
echo ""
echo "ğŸ“ ARQUIVOS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "  Modificados (3):"
echo "    â€¢ src/infra/logger/Logger.ts"
echo "    â€¢ src/infra/db/CustomORM.ts"
echo "    â€¢ src/infra/logger/HTTPLoggerMiddleware.ts"
echo ""
echo "  DocumentaÃ§Ã£o (3):"
echo "    â€¢ docs/LOGGING-WITH-UUID.md (completo)"
echo "    â€¢ docs/LOGGING-UUID-SUMMARY.md (resumo)"
echo "    â€¢ IMPLEMENTATION-SUMMARY.md (atualizado)"
echo ""
echo "  Exemplo completo (11 arquivos):"
echo "    â€¢ examples/logging-example/"
echo "      - API REST funcional"
echo "      - Todas as camadas (Route â†’ Business â†’ Repository â†’ ORM)"
echo "      - Script de teste"
echo "      - DocumentaÃ§Ã£o"
echo ""
echo ""
echo "ğŸ§ª TESTAR O EXEMPLO"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "  cd examples/logging-example"
echo "  cp .env.example .env"
echo "  createdb logging_example"
echo "  psql -d logging_example -f migrations/001_create_products_table.sql"
echo "  npm install"
echo "  npm run dev"
echo ""
echo "  # Em outro terminal:"
echo "  chmod +x test-logging.sh"
echo "  ./test-logging.sh"
echo ""
echo ""
echo "ğŸ“š DOCUMENTAÃ‡ÃƒO"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "  â€¢ DocumentaÃ§Ã£o completa:"
echo "    docs/LOGGING-WITH-UUID.md"
echo ""
echo "  â€¢ Resumo executivo:"
echo "    docs/LOGGING-UUID-SUMMARY.md"
echo ""
echo "  â€¢ Exemplo:"
echo "    examples/logging-example/README.md"
echo ""
echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                                                                            â•‘"
echo "â•‘                         âœ… IMPLEMENTAÃ‡ÃƒO COMPLETA!                        â•‘"
echo "â•‘                                                                            â•‘"
echo "â•‘  Sistema de logging com UUID Ãºnico por requisiÃ§Ã£o funcionando             â•‘"
echo "â•‘  em todas as camadas, incluindo queries SQL no banco de dados.            â•‘"
echo "â•‘                                                                            â•‘"
echo "â•‘                  Pronto para uso em produÃ§Ã£o! ğŸš€                          â•‘"
echo "â•‘                                                                            â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
